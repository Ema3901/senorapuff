<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Descargar Excel - Talleres y Laboratorios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
    <link href="../../css/style.css" rel="stylesheet" />
</head>
<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="sidebar-header" title="Menú">Inventario</div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="../../index.html"><i class="fas fa-cubes"></i> Inventario</a></li>
                    <li><a href="../../deshabilitados.html"><i class="fas fa-archive"></i> Desactivados</a></li>
                    <li><a href="../../pendientes.html"><i class="fas fa-exclamation-circle"></i> Pendientes Check</a></li>
                    <li><a href="../../dashboard.html"><i class="fas fa-shield-alt"></i> Panel administrativo</a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <header class="main-header d-flex align-items-center justify-content-between flex-wrap">
                <h1>Talleres y Laboratorios</h1>
                <div class="user-box dropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <img src="img/stock.jpg" alt="User Avatar" id="profileDropdown"/>
                    <span>Ann Lee</span>
                    <i class="fas fa-chevron-down ml-2"></i>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
                        <li><a class="dropdown-item" href="#" onclick="window.location.href='login.html'; return false;">Cerrar sesión</a></li>
                    </ul>
                </div>
            </header>

            <div class="divider"></div>

            <!-- Información y botón de descarga -->
            <div class="mb-4">
                <div class="alert alert-info d-flex align-items-center">
                    <i class="fas fa-info-circle me-2"></i>
                    <span>Esta página te permite descargar un archivo Excel con información específica de talleres y laboratorios activos del inventario.</span>
                </div>
                
                <div class="d-flex align-items-center gap-3 mb-3">
                    <button class="btn btn-success" id="descargarExcelBtn" onclick="descargarExcel()">
                        <i class="fas fa-file-excel me-2"></i>Descargar Excel Talleres
                    </button>
                    <span class="text-muted">Total de elementos activos: <strong id="totalProductos">0</strong></span>
                </div>
            </div>

            <!-- Tabla de vista previa -->
            <div class="table-container">
                <h5 class="mb-3">Vista previa de datos:</h5>
                <table id="excelTable">
                    <thead>
                        <tr>
                            <th>Número de item</th>
                            <th>Nombre del taller o laboratorio</th>
                            <th>Cantidad en existencia</th>
                            <th>Modelo</th>
                            <th>Marca</th>
                            <th>Fabricante</th>
                            <th>Código de inventario</th>
                            <th>Número de serie</th>
                            <th>Especificaciones técnicas</th>
                            <th>Fotografía</th>
                            <th>Ubicación del equipo</th>
                            <th>Observaciones</th>
                        </tr>
                    </thead>
                    <tbody id="excelTableBody">
                        <!-- Las filas se generarán dinámicamente -->
                    </tbody>
                </table>
            </div>

            <!-- Loading indicator -->
            <div id="loadingIndicator" class="text-center py-5" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-3">Cargando datos de talleres y laboratorios...</p>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
    <!-- SheetJS para generar Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // Variable global para almacenar los datos del inventario
        let inventoryData = [];

        // Función para cargar datos de la API
        async function loadInventoryData() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const tableContainer = document.querySelector('.table-container');
            
            try {
                loadingIndicator.style.display = 'block';
                tableContainer.style.display = 'none';
                
                // Cargar datos de la API
                const response = await fetch('https://healtyapi.bsite.net/api/InventarioCombinado/Excel');
                const data = await response.json();
                
                // Filtrar solo productos activos
                const activeData = data.filter(item => item.Status === "Activado");
                
                // Mapear los datos para Excel con los campos específicos para talleres
                inventoryData = activeData.map(item => ({
                    'Número de item': item.NumeroDeItem || 'N/A',
                    'Nombre del taller o laboratorio': item.NombreDeTallerOLaboratorio || 'N/A',
                    'Cantidad en existencia': item.CantidadEnExistencia || 0,
                    'Modelo': item.Modelo || 'N/A',
                    'Marca': item.Marca || 'N/A',
                    'Fabricante': item.Fabricante || 'N/A',
                    'Código de inventario': item.CodigoDeInventario || 'N/A',
                    'Número de serie': item.NumeroSerie || 'N/A',
                    'Especificaciones técnicas': item.EspecificacionesTecnicas || 'No especificadas',
                    'Fotografía': item.Fotografia || 'Sin fotografía',
                    'Ubicación del equipo': item.Ubicacion || 'Sin ubicación',
                    'Observaciones': item.Observaciones || 'Sin observaciones'
                }));

                // Actualizar contador
                document.getElementById('totalProductos').textContent = inventoryData.length;
                
                // Generar tabla
                generateTableRows();
                
                loadingIndicator.style.display = 'none';
                tableContainer.style.display = 'block';
                
            } catch (error) {
                console.error('Error cargando datos del inventario:', error);
                loadingIndicator.style.display = 'none';
                
                // Mostrar mensaje de error
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger';
                alertDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error al cargar los datos del inventario. Por favor, intente de nuevo.';
                document.querySelector('.main-content').insertBefore(alertDiv, tableContainer);
            }
        }

        // Función para generar las filas de la tabla
        function generateTableRows() {
            const tbody = document.getElementById('excelTableBody');
            tbody.innerHTML = '';

            // Mostrar máximo 10 filas como vista previa
            const previewData = inventoryData.slice(0, 10);
            
            previewData.forEach((item) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item['Número de item']}</td>
                    <td>${item['Nombre del taller o laboratorio']}</td>
                    <td>${item['Cantidad en existencia']}</td>
                    <td>${item['Modelo']}</td>
                    <td>${item['Marca']}</td>
                    <td>${item['Fabricante']}</td>
                    <td>${item['Código de inventario']}</td>
                    <td>${item['Número de serie']}</td>
                    <td>${item['Especificaciones técnicas']}</td>
                    <td>${item['Fotografía']}</td>
                    <td>${item['Ubicación del equipo']}</td>
                    <td>${item['Observaciones']}</td>
                `;
                tbody.appendChild(row);
            });

            // Agregar fila indicando que hay más datos
            if (inventoryData.length > 10) {
                const moreRow = document.createElement('tr');
                moreRow.innerHTML = `
                    <td colspan="12" class="text-center text-muted py-3">
                        <em>... y ${inventoryData.length - 10} elementos más que aparecerán en el Excel</em>
                    </td>
                `;
                tbody.appendChild(moreRow);
            }
        }

        // Función para descargar Excel
        function descargarExcel() {
            if (inventoryData.length === 0) {
                alert('No hay datos para descargar. Por favor, espere a que se carguen los datos.');
                return;
            }

            try {
                // Crear un nuevo workbook
                const wb = XLSX.utils.book_new();
                
                // Convertir datos a worksheet
                const ws = XLSX.utils.json_to_sheet(inventoryData);
                
                // Ajustar el ancho de las columnas
                const colWidths = [
                    { wch: 15 }, // Número de item
                    { wch: 30 }, // Nombre del taller
                    { wch: 10 }, // Cantidad en existencia
                    { wch: 15 }, // Modelo
                    { wch: 15 }, // Marca
                    { wch: 15 }, // Fabricante
                    { wch: 20 }, // Código de inventario
                    { wch: 15 }, // Número de serie
                    { wch: 40 }, // Especificaciones técnicas
                    { wch: 15 }, // Fotografía
                    { wch: 25 }, // Ubicación del equipo
                    { wch: 30 }  // Observaciones
                ];
                ws['!cols'] = colWidths;
                
                // Agregar worksheet al workbook
                XLSX.utils.book_append_sheet(wb, ws, "Talleres y Laboratorios");
                
                // Generar nombre del archivo con fecha actual
                const fecha = new Date().toISOString().split('T')[0];
                const nombreArchivo = `Talleres_Laboratorios_${fecha}.xlsx`;
                
                // Descargar archivo
                XLSX.writeFile(wb, nombreArchivo);
                
                // Mostrar mensaje de éxito
                const successAlert = document.createElement('div');
                successAlert.className = 'alert alert-success alert-dismissible fade show';
                successAlert.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    ¡Excel descargado exitosamente! Archivo: ${nombreArchivo}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.main-content').insertBefore(successAlert, document.querySelector('.mb-4'));
                
                // Auto-remover la alerta después de 5 segundos
                setTimeout(() => {
                    if (successAlert.parentNode) {
                        successAlert.remove();
                    }
                }, 5000);
                
            } catch (error) {
                console.error('Error generando Excel:', error);
                alert('Error al generar el archivo Excel. Por favor, intente de nuevo.');
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar datos al inicializar la página
            loadInventoryData();
        });
    </script>
</body>
</html>