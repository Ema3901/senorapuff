<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editar Workshop - Inventario</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
</head>
<body>
  <div class="dashboard-container">
    <aside class="sidebar">
      <div class="sidebar-header">Inventario</div>
      <nav class="sidebar-nav">
        <ul>
          <li><a href="index.html"><i class="fas fa-boxes"></i> <span>Inventario</span></a></li>
          <li><a href="deshabilitados.html"><i class="fas fa-trash-alt"></i> <span>Desactivados</span></a></li>
          <li><a href="pendientes.html"><i class="fas fa-clock"></i> <span>Pendientes Check</span></a></li>
          <li><a href="dashboard.html" class="active"><i class="fas fa-tachometer-alt"></i> Panel administrativo</a></li>
        </ul>
      </nav>
    </aside>

    <main class="main-content">
      <header class="main-header">
        <div class="d-flex align-items-center">
          <button class="btn btn-outline-secondary me-3" onclick="window.location.href='index.html'">
            <i class="fas fa-arrow-left"></i>
          </button>
          <h1>Editar Workshop</h1>
        </div>
      </header>

      <div class="divider"></div>

      <div class="container mt-4">
        <div class="card">
          <div class="card-header bg-info text-white">
            <h5><i class="fas fa-industry me-2"></i>Formulario de Workshop</h5>
          </div>
          <div class="card-body">
            <form id="editWorkshopForm" novalidate>
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="id_pruduct" class="form-label">ID Producto</label>
                    <input type="number" class="form-control" id="id_pruduct" readonly>
                  </div>
                  <div class="mb-3">
                    <label for="p_name" class="form-label">Nombre *</label>
                    <input type="text" class="form-control" id="p_name" required>
                    <div class="invalid-feedback">Por favor ingrese un nombre válido.</div>
                  </div>
                  <div class="mb-3">
                    <label for="quantyty" class="form-label">Cantidad *</label>
                    <input type="number" class="form-control" id="quantyty" min="1" required>
                    <div class="invalid-feedback">Por favor ingrese una cantidad válida.</div>
                  </div>
                  <div class="mb-3">
                    <label for="modelo" class="form-label">Modelo</label>
                    <input type="text" class="form-control" id="modelo">
                  </div>
                  <div class="mb-3">
                    <label for="fk_brand" class="form-label">Marca *</label>
                    <select class="form-select" id="fk_brand" required>
                      <option value="">-- Seleccione --</option>
                    </select>
                    <div class="invalid-feedback">Por favor seleccione una marca.</div>
                  </div>
                  <div class="mb-3">
                    <label for="inv_code" class="form-label">Código de Inventario</label>
                    <input type="text" class="form-control" id="inv_code">
                  </div>
                  <div class="mb-3">
                    <label for="serial_n" class="form-label">Serial</label>
                    <input type="text" class="form-control" id="serial_n">
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="specs" class="form-label">Especificaciones</label>
                    <textarea class="form-control" id="specs" rows="3"></textarea>
                  </div>
                  <div class="mb-3">
                    <label for="foto" class="form-label">Foto</label>
                    <input type="text" class="form-control" id="foto" placeholder="URL de la foto">
                  </div>
                  <div class="mb-3">
                    <label for="fk_lab" class="form-label">Laboratorio *</label>
                    <select class="form-select" id="fk_lab" required>
                      <option value="">-- Seleccione --</option>
                    </select>
                    <div class="invalid-feedback">Por favor seleccione un laboratorio.</div>
                  </div>
                  <div class="mb-3">
                    <label for="fk_area" class="form-label">Área *</label>
                    <select class="form-select" id="fk_area" required>
                      <option value="">-- Seleccione --</option>
                    </select>
                    <div class="invalid-feedback">Por favor seleccione un área.</div>
                  </div>
                  <div class="mb-3">
                    <label for="fk_location" class="form-label">Ubicación *</label>
                    <select class="form-select" id="fk_location" required>
                      <option value="">-- Seleccione --</option>
                    </select>
                    <div class="invalid-feedback">Por favor seleccione una ubicación.</div>
                  </div>
                  <div class="mb-3">
                    <label for="observations" class="form-label">Observaciones</label>
                    <textarea class="form-control" id="observations" rows="3"></textarea>
                  </div>
                  <div class="mb-3">
                    <label for="fk_user" class="form-label">Resguardante *</label>
                    <select class="form-select" id="fk_user" required>
                      <option value="">-- Seleccione --</option>
                    </select>
                    <div class="invalid-feedback">Por favor seleccione un resguardante.</div>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="card-footer">
            <button type="button" class="btn btn-info" id="btnGuardarWorkshop">
              <i class="fas fa-save me-2"></i>Guardar Cambios
            </button>
            <button type="button" class="btn btn-secondary ms-3" onclick="window.location.href='index.html'">
              <i class="fas fa-times me-2"></i>Cancelar
            </button>
            <div class="spinner-border text-info ms-2 d-none" id="loadingSpinner" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal de confirmación -->
  <div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirmar cambios</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>¿Está seguro de que desea guardar los cambios en este workshop?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-info" id="btnConfirmar">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_BASE = 'https://healtyapi.bsite.net/api';
    let workshopId = null;
    let isLoading = false;

    // Inicializar
    document.addEventListener('DOMContentLoaded', () => {
      workshopId = new URLSearchParams(window.location.search).get('id');
      if (workshopId) {
        loadWorkshopData();
      } else {
        showMessage('ID de workshop no proporcionado', 'error');
        setTimeout(() => window.location.href = 'index.html', 2000);
      }
      
      loadSelectOptions();
      setupEventListeners();
    });

    function setupEventListeners() {
      document.getElementById('btnGuardarWorkshop').addEventListener('click', validateAndShowConfirm);
      document.getElementById('btnConfirmar').addEventListener('click', saveWorkshop);
      
      // Validación en tiempo real
      const inputs = document.querySelectorAll('input, select, textarea');
      inputs.forEach(input => {
        input.addEventListener('blur', validateField);
        input.addEventListener('input', clearFieldError);
      });
    }

    async function loadWorkshopData() {
      try {
        showLoading(true);
        const response = await fetch(`${API_BASE}/inv_workshop/${workshopId}`);
        
        if (!response.ok) {
          throw new Error('Workshop no encontrado');
        }
        
        const workshop = await response.json();
        populateForm(workshop);
      } catch (error) {
        console.error('Error loading workshop:', error);
        showMessage('Error al cargar los datos del workshop', 'error');
      } finally {
        showLoading(false);
      }
    }

    async function loadSelectOptions() {
      try {
        const [brands, labs, areas, locations, users] = await Promise.all([
          fetch(`${API_BASE}/brands`).then(r => r.json()),
          fetch(`${API_BASE}/laboratories`).then(r => r.json()),
          fetch(`${API_BASE}/areas`).then(r => r.json()),
          fetch(`${API_BASE}/product_location`).then(r => r.json()),
          fetch(`${API_BASE}/users`).then(r => r.json())
        ]);

        populateSelect('fk_brand', brands, 'id_brand', 'brand_name');
        populateSelect('fk_lab', labs, 'id_lab', 'lab_name');
        populateSelect('fk_area', areas, 'id_area', 'area_name');
        populateSelect('fk_location', locations, 'id_location', 'location_name');
        populateSelect('fk_user', users, 'id_user', 'name');
      } catch (error) {
        console.error('Error loading options:', error);
        showMessage('Error al cargar las opciones', 'error');
      }
    }

    function populateSelect(selectId, data, valueField, textField) {
      const select = document.getElementById(selectId);
      select.innerHTML = '<option value="">-- Seleccione --</option>';
      
      data.forEach(item => {
        const option = document.createElement('option');
        option.value = item[valueField];
        option.textContent = item[textField];
        select.appendChild(option);
      });
    }

    function populateForm(workshop) {
      document.getElementById('id_pruduct').value = workshop.id_pruduct || workshopId;
      document.getElementById('p_name').value = workshop.p_name || '';
      document.getElementById('quantyty').value = workshop.quantyty || 1;
      document.getElementById('modelo').value = workshop.modelo || '';
      document.getElementById('inv_code').value = workshop.inv_code || '';
      document.getElementById('serial_n').value = workshop.serial_n || '';
      document.getElementById('specs').value = workshop.specs || '';
      document.getElementById('foto').value = workshop.foto || '';
      document.getElementById('observations').value = workshop.observations || '';
      
      // Set select values after options are loaded
      setTimeout(() => {
        if (workshop.fk_brand) document.getElementById('fk_brand').value = workshop.fk_brand;
        if (workshop.fk_lab) document.getElementById('fk_lab').value = workshop.fk_lab;
        if (workshop.fk_area) document.getElementById('fk_area').value = workshop.fk_area;
        if (workshop.fk_location) document.getElementById('fk_location').value = workshop.fk_location;
        if (workshop.fk_user) document.getElementById('fk_user').value = workshop.fk_user;
      }, 100);
    }

    function validateField(event) {
      const field = event.target;
      const value = field.value.trim();
      
      let isValid = true;
      
      if (field.hasAttribute('required') && !value) {
        isValid = false;
      } else if (field.type === 'number') {
        const num = parseInt(value);
        const min = parseInt(field.min) || 0;
        isValid = !isNaN(num) && num >= min;
      }
      
      field.classList.toggle('is-invalid', !isValid);
      return isValid;
    }

    function clearFieldError(event) {
      event.target.classList.remove('is-invalid');
    }

    function validateForm() {
      const form = document.getElementById('editWorkshopForm');
      const requiredFields = form.querySelectorAll('[required]');
      let isValid = true;
      
      requiredFields.forEach(field => {
        if (!validateField({ target: field })) {
          isValid = false;
        }
      });
      
      return isValid;
    }

    function validateAndShowConfirm() {
      if (!validateForm()) {
        showMessage('Por favor complete todos los campos requeridos', 'error');
        return;
      }
      
      const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
      modal.show();
    }

    async function saveWorkshop() {
      if (isLoading) return;
      
      const formData = {
        p_name: document.getElementById('p_name').value.trim(),
        quantyty: parseInt(document.getElementById('quantyty').value),
        modelo: document.getElementById('modelo').value.trim() || null,
        fk_brand: parseInt(document.getElementById('fk_brand').value),
        inv_code: document.getElementById('inv_code').value.trim() || null,
        serial_n: document.getElementById('serial_n').value.trim() || null,
        specs: document.getElementById('specs').value.trim() || null,
        foto: document.getElementById('foto').value.trim() || null,
        fk_lab: parseInt(document.getElementById('fk_lab').value),
        fk_area: parseInt(document.getElementById('fk_area').value),
        fk_location: parseInt(document.getElementById('fk_location').value),
        observations: document.getElementById('observations').value.trim() || null,
        fk_user: parseInt(document.getElementById('fk_user').value)
      };

      try {
        isLoading = true;
        showLoading(true);
        
        const response = await fetch(`${API_BASE}/inv_workshop/partial/${workshopId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        });

        if (response.ok) {
          showMessage('Workshop actualizado exitosamente', 'success');
          setTimeout(() => window.location.href = 'index.html', 1500);
        } else {
          const error = await response.json();
          throw new Error(error.message || 'Error al actualizar el workshop');
        }
      } catch (error) {
        console.error('Error saving workshop:', error);
        showMessage(error.message || 'Error al guardar los cambios', 'error');
      } finally {
        isLoading = false;
        showLoading(false);
        bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
      }
    }

    function showLoading(show) {
      const spinner = document.getElementById('loadingSpinner');
      const button = document.getElementById('btnGuardarWorkshop');
      
      if (show) {
        spinner.classList.remove('d-none');
        button.disabled = true;
      } else {
        spinner.classList.add('d-none');
        button.disabled = false;
      }
    }

    function showMessage(message, type) {
      const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
      const alert = document.createElement('div');
      alert.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
      alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
      alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(alert);
      
      setTimeout(() => {
        if (alert.parentNode) {
          alert.remove();
        }
      }, 5000);
    }
  </script>
</body>
</html>
