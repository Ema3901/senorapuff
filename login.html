<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inicio de sesión - Inventarios de carrera</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link href="css/login.css" rel="stylesheet" />
  <style>
    /* Estilos para la animación de carga */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .loading-content {
      text-align: center;
      color: white;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .btn-login:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .success-message {
      background: #eafaf1;
      color: #27ae60;
      padding: 0.75rem;
      border-radius: 5px;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      display: none;
    }


  </style>
</head>
<body>
  <!-- Overlay de carga -->
  <div class="loading-overlay" id="loading-overlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <p>Iniciando sesión...</p>
    </div>
  </div>

  <div class="login-container" role="main">
    <section class="login-form" aria-label="Formulario de inicio de sesión">
      <h2>Inicio de sesión</h2>
      <p class="subtitle">Inventarios de carrera</p>

      <div class="success-message" id="successMessage"></div>

      <form action="#" method="POST" novalidate id="login-form">
        <label for="email">Correo*</label>
        <input id="email" name="email" type="email" placeholder="Introduce tu correo" required />

        <label for="password">Contraseña*</label>
        <input id="password" name="password" type="password" placeholder="mínimo 8 caracteres" minlength="8" required />

        <button type="submit" class="btn-login" id="login-btn">
          <span class="btn-text">Iniciar sesión</span>
          <span class="btn-loading" style="display: none;">
            <i class="fas fa-spinner fa-spin"></i> Iniciando...
          </span>
        </button>
        <div id="login-error" class="text-danger mt-2" style="display: none;"></div>
      </form>


    </section>

    <section class="login-logo" aria-label="Logo UT Tamaulipas Norte">
      <img src="img/logoUT.png" alt="Logo Universidad Tecnológica Tamaulipas Norte" />
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="js/mobile.js"></script>

<script>
  // SessionManager del código funcional
  class SessionManager {
    constructor() {
      this.user = null;
      this.apiBaseUrl = 'https://inventariolabsapi.uttn.app/api';
    }

    async login(email, password) {
      try {
        console.log('Iniciando proceso de login para:', email);
        
        const response = await fetch(`${this.apiBaseUrl}/users`);
        
        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status}`);
        }

        const users = await response.json();
        console.log('Usuarios obtenidos:', users.length);

        const user = users.find(u => 
          u.email === email && u.password === password
        );

        if (!user) {
          throw new Error('Credenciales incorrectas');
        }

        // Verifica si el rol del usuario es 'alumno' (id_rol === 3)
        if (user.RoleInfo && user.RoleInfo.id_rol === 3) {
          throw new Error('Acceso no permitido para estudiantes');
        }

        this.user = user;
        this.saveUserToSession(user);
        
        console.log('Login exitoso para:', user.name);
        
        return {
          success: true,
          user: user,
          message: 'Login exitoso'
        };

      } catch (error) {
        console.error('Error en login:', error);
        return {
          success: false,
          message: error.message || 'Error al iniciar sesión'
        };
      }
    }

    saveUserToSession(user) {
      try {
        sessionStorage.setItem("usuario", JSON.stringify(user));
        console.log("Usuario guardado en sesión:", user.name);
      } catch (error) {
        console.error("Error al guardar usuario en sesión:", error);
      }
    }

    getCurrentUser() {
      return this.user;
    }

    getCurrentRole() {
      if (!this.user || !this.user.RoleInfo) {
        return null;
      }
      return {
        id: this.user.RoleInfo.id_rol,
        name: this.user.RoleInfo.rol1 || this.user.RoleInfo.rol
      };
    }
  }

  // Inicializar el administrador de sesión
  const sessionManager = new SessionManager();

  // Elementos del DOM
  const loginForm = document.getElementById('login-form');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const loginBtn = document.getElementById('login-btn');
  const errorDiv = document.getElementById('login-error');
  const successMessage = document.getElementById('successMessage');
  const loadingOverlay = document.getElementById('loading-overlay');

  // Función para mostrar/ocultar la animación de carga
  function toggleLoading(show) {
    const btnText = loginBtn.querySelector(".btn-text");
    const btnLoading = loginBtn.querySelector(".btn-loading");
    
    if (show) {
      loadingOverlay.style.display = "flex";
      loginBtn.disabled = true;
      btnText.style.display = "none";
      btnLoading.style.display = "inline";
    } else {
      loadingOverlay.style.display = "none";
      loginBtn.disabled = false;
      btnText.style.display = "inline";
      btnLoading.style.display = "none";
    }
  }

  // Función para mostrar mensajes
  function showMessage(message, isError = false) {
    if (isError) {
      errorDiv.innerText = message;
      errorDiv.style.display = 'block';
      successMessage.style.display = 'none';
    } else {
      successMessage.textContent = message;
      successMessage.style.display = 'block';
      errorDiv.style.display = 'none';
    }
  }

  function hideMessages() {
    errorDiv.style.display = 'none';
    successMessage.style.display = 'none';
  }



  // Función principal de login
  async function login() {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    
    hideMessages();

    // Verifica si los campos están completos
    if (!email || !password) {
      showMessage("Completa todos los campos.", true);
      return;
    }

    // Verifica que el correo tenga el dominio correcto
    if (!email.endsWith("@uttn.mx")) {
      showMessage("Solo se permiten correos institucionales @uttn.mx", true);
      return;
    }

    toggleLoading(true);

    try {
      const result = await sessionManager.login(email, password);
      
      if (result.success) {
        showMessage(result.message);
        
        // Redirigir después de 1 segundo
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 1000);
        
      } else {
        showMessage(result.message, true);
      }
      
    } catch (error) {
      showMessage('Error inesperado. Inténtalo de nuevo.', true);
      console.error('Error en login:', error);
    }
    
    toggleLoading(false);
  }

  // Event listeners
  document.addEventListener("DOMContentLoaded", function() {
    // Agregar event listener para el formulario
    loginForm.addEventListener("submit", function(e) {
      e.preventDefault();
      login();
    });

    // Event listeners para presionar Enter
    emailInput.addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        e.preventDefault();
        login();
      }
    });

    passwordInput.addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        e.preventDefault();
        login();
      }
    });

    // Limpiar mensajes cuando el usuario empiece a escribir
    emailInput.addEventListener('input', hideMessages);
    passwordInput.addEventListener('input', hideMessages);
  });

  // Función para cerrar sesión
  function logout() {
    sessionStorage.removeItem("usuario");
    window.location.href = "login.html";
  }
</script>

</body>
</html>